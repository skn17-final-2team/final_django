{% extends "core/base.html" %}
{% load static %}

{% block title %}회의 전문{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/meeting_transcript.css' %}">
{% endblock %}

{% block content %}
<div class="meeting-transcript-page">
  <!-- 상단 제목 + 우측 라인 -->
  <div class="transcript-header-row">
    <h2 class="record-title" id="recordTitle"></h2>
    <div class="record-title-line"></div>
  </div>

  <!-- 좌우 2컬럼 레이아웃 -->
  <div class="transcript-layout">
    <!-- ========== 왼쪽 : 전문 ========== -->
    <section class="transcript-left">
      <div class="section-label">전문</div>

      <div class="assign-transcript-box">
        <!-- 실제 스크롤 영역 -->
        <div class="assign-transcript-scroll" id="assign-transcript-scroll" style="white-space: pre-line;"></div>
      </div>

      <div class="assign-transcript-actions">
        {% if meeting.record_url %}
          <button
            type="button"
            class="text-link-button"
            id="btn-audio-download"
            data-meeting-id="{{ meeting.meeting_id }}"
          >
            음성 파일 다운로드
          </button>
        {% else %}
          <button type="button" class="text-link-button text-link-disabled" disabled>
            음성 파일 다운로드
          </button>
        {% endif %}

        <button
          type="button"
          class="text-link-button"
          id="btn-copy-full-transcript"
        >
          전문 전체 복사
        </button>
      </div> 
    </section>

    <!-- ========== 오른쪽 : 발화자 지정 + 전문 미리보기 ========== -->
    <section class="transcript-right">
      <!-- 발화자 지정 -->
      <div class="speaker-assign-block">
        <div class="section-label">발화자 지정</div>

        <div class="speaker-assign-grid">
          <div class="speaker-assign-column" id="speakerAssignColumn"></div>
        </div>
      </div>

      <div class="meeting-transcript-actions">
        <button type="button" class="btn-transcript-save">
          저장
        </button>
      </div>
    </section>
  </div>
</div>
<script>
  const meetingId = "{{ meeting_id }}";
  const recordTitle = document.getElementById("recordTitle")
  const transcript = document.getElementById("assign-transcript-scroll")
  const container = document.getElementById("speakerAssignColumn");

  fetch(`/meetings/${meetingId}/transcript_api/`)
    .then(response => response.json())
    .then(data => {
      const speakers = data.speakers
      
      const speakerMap = {};
      speakers.forEach(sp => {
        speakerMap[sp] = sp;
      });
      console.log(speakerMap)
      recordTitle.textContent = data.meeting_title;
      transcript_data = JSON.parse(data.transcript.replaceAll("'", '"'));
      transcript.textContent = transcript_parse(transcript_data).join("\n")
      

      speakers.forEach(speaker => {
        const row = document.createElement("div");
        row.className = "speaker-row";
        const label = document.createElement("span");

        label.className = "speaker-label";
        label.textContent = speaker;

        const select = document.createElement("select");
        select.className = "speaker-select";
        select.name = speaker;
        select.id = speaker;

        const emptyOption = document.createElement("option");
        emptyOption.value = "";
        emptyOption.textContent = speaker;
        select.appendChild(emptyOption);

        data.attendees.forEach(att => {
          const option = document.createElement("option");
          option.value = att.user_id;
          option.textContent = `${att.name} (${att.dept_name})`;
          select.appendChild(option);
        });

        select.addEventListener("change", e => {
          speakerMap[e.target.id] = e.target.options[e.target.selectedIndex].text;
          console.log(speakerMap);
          transcript.textContent = transcript_parse(transcript_data, speakerMap).join("\n")
        });

        row.appendChild(label);
        row.appendChild(select);
        container.appendChild(row);
      })
    })
    .catch(err => console.error("API 호출 실패:", err));
  
  function transcript_parse(data, setkeys=false) {
    const resultList = [];
    const keys = new Set();

    for (const f of data) {
      for (let [key, value] of Object.entries(f)) {
        if (setkeys) {
          key = setkeys[key];
        }
        resultList.push(`${key}: ${value}`);
      }
    }
    return resultList;
  }
</script>
{% endblock %}
{% block extra_script %}
<script src="{% static 'js/meeting_common.js' %}"></script>
{% endblock %}