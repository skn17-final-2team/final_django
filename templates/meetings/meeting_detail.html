{% extends "core/base.html" %}
{% load static %}


{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/meeting_detail.css' %}">
{% endblock %}

{% block content %}
<div id="meeting-detail-root" class="meeting-detail-page" data-meeting-id="{{ meeting.meeting_id }}">
  <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
  <!-- 상단 제목 + 우측 라인 + 화살표 버튼 -->
  <div class="detail-header-row">
    <div class="detail-meeting-title-container">
      <h2 class="detail-page-title">{{ meeting.title }}</h2>
      <button
        type="button"
        class="meeting-info-toggle"
        id="meeting-info-toggle"
        aria-expanded="false"
      >
        <span class="meeting-info-arrow"></span>
      </button>
    </div>
    <div class="detail-page-title-line"></div>
  </div>

  <!--회의 정보 팝업 오버레이 -->
  <div class="meeting-info-overlay" id="meeting-info-overlay">
    <div class="meeting-info-modal">
      <div class="meeting-info-header">
        <button type="button" class="meeting-info-close" id="meeting-info-close">
          ✕
        </button>
      </div>

      <div class="meeting-info-body">
        <p class="meeting-info-line">
          <span class="meeting-info-label">일시 :</span>
          <span class="meeting-info-value">
            {{ meeting.meet_date_time|date:"Y.m.d  H:i" }}
          </span>
        </p>

        <p class="meeting-info-line">
          <span class="meeting-info-label">장소 :</span>
          <span class="meeting-info-value">
            {{ meeting.place }}
          </span>
        </p>

        <p class="meeting-info-line meeting-info-line-attendees-label">
          <span class="meeting-info-label">참여자 :</span>
        </p>

        <ul class="meeting-info-attendee-list">
          {% for att in attendees %}
            <li>
              {{ att.user.name }}
              {% if att.user.dept %}
                ({{ att.user.dept.dept_name }})
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <!-- 좌우 2컬럼 레이아웃 -->
  <div class="detail-layout">
    <!-- ========== 왼쪽 : 전문 ========== -->
    <section class="detail-left">
      <div class="section-label">전문</div>

      <div class="detail-transcript-box">
        <div class="detail-transcript-scroll" id="detail-transcript-scroll">
          {# transcript_html이 이미 있는 경우 우선 사용, 없으면 meeting.transcript #}
          {% if transcript_html %}
            {{ transcript_html|safe }}
          {% else %}
            {{ meeting.transcript|linebreaksbr }}
          {% endif %}
        </div>
      </div>

      <div class="detail-transcript-actions">
        {% if meeting.record_url %}
          <button
            type="button"
            class="text-link-button"
            id="btn-audio-download"
            data-meeting-id="{{ meeting.meeting_id }}"
          >
            음성 파일 다운로드
          </button>
        {% else %}
          <button type="button" class="text-link-button text-link-disabled" disabled>
            음성 파일 다운로드
          </button>
        {% endif %}

        <button
          type="button"
          class="text-link-button"
          id="btn-copy-full-transcript"
        >
          전문 전체 복사
        </button>
      </div>
    </section>

    <!-- ========== 오른쪽 : 요약 / 태스크 / 회의록 탭 ========== -->
    <section class="detail-right">
      <!-- 탭 헤더 -->
      <div class="detail-tabs">
        <button
          type="button"
          class="detail-tab detail-tab-active"
          data-tab-target="summary"
        >
          요약
        </button>
        <button
          type="button"
          class="detail-tab"
          data-tab-target="tasks"
        >
          태스크
        </button>
        <button
          type="button"
          class="detail-tab"
          data-tab-target="minutes"
        >
          회의록
        </button>
      </div>

      <!-- 탭 콘텐츠 영역 -->
      <div class="detail-tab-panels">
        <!-- 요약 탭 -->
        <div
          class="detail-tab-panel detail-tab-panel-active"
          id="tab-summary"
          data-tab-panel="summary"
        >
          <div class="detail-summary-box">
            {% if meeting.summary %}
              {{ meeting.summary|linebreaksbr }}
            {% else %}
              <p class="detail-empty-text">요약 내용이 아직 등록되지 않았습니다.</p>
            {% endif %}
          </div>
        </div>

        <!-- 태스크 탭 -->
        <div
          class="detail-tab-panel"
          id="tab-tasks"
          data-tab-panel="tasks"
        >
          <div class="detail-task-box">
            <div class="detail-task-header">
              <div class="detail-task-col detail-task-col-who">Who</div>
              <div class="detail-task-col detail-task-col-what">What</div>
              <div class="detail-task-col detail-task-col-when">When</div>
              <div class="detail-task-col detail-task-col-add">Add</div>
            </div>

            <div class="detail-task-body">
              {% if tasks %}
                {% for task in tasks %}
                  <div class="detail-task-row">
                    <div class="detail-task-col detail-task-col-who">
                      {% if task.assignee %}
                        {{ task.assignee.name }}{% if task.assignee.dept %}, {{ task.assignee.dept.dept_name }}{% endif %}
                      {% else %}
                        -
                      {% endif %}
                    </div>
                    <div class="detail-task-col detail-task-col-what">
                      {{ task.task_content }}
                    </div>
                    <div class="detail-task-col detail-task-col-when">
                      {% if task.due_date %}
                        {{ task.due_date|date:"Y.m.d" }}
                      {% else %}
                        -
                      {% endif %}
                    </div>
                    <div class="detail-task-col detail-task-col-add">
                      <button type="button" class="detail-task-add-btn">
                        추가
                      </button>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <p class="detail-empty-text">등록된 태스크가 없습니다.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- 회의록 탭 -->
        <div
          class="detail-tab-panel"
          id="tab-minutes"
          data-tab-panel="minutes"
        >
          <div class="detail-minutes-wrapper">
            <div class="detail-minutes-box">
              {# 웹에서 수정 가능한 편집 영역 #}
              <div
                id="minutes-editor"
                class="minutes-editor"
                contenteditable="true"
              >
                {% if meeting.meeting_notes %}
                  {{ meeting.meeting_notes|safe }}
                {% endif %}
              </div>
            </div>

            <div class="detail-minutes-actions">

              <button
                type="button"
                class="detail-minutes-btn"
                id="btn-minutes-save"
              >
                회의록 저장
              </button>

              <a
                href="{% url 'meetings:minutes_download' meeting.meeting_id 'pdf' %}"
                class="detail-minutes-btn"
              >
                pdf 다운로드
              </a>
              <a
                href="{% url 'meetings:minutes_download' meeting.meeting_id 'docx' %}"
                class="detail-minutes-btn"
              >
                word 다운로드
              </a>
            </div>
          </div>
        </div>

  {# ====== 회의록 섹션 템플릿 (화면에는 보이지 않음) ====== #}
  <div id="minutes-templates" style="display: none;">

    {# base: 기본정보(안건/일시/장소/참석인원) + 주요안건 #}
    <div id="minutes-template-base">
      <table class="minutes-table">
        <colgroup>
          <col style="width: 20%;">
          <col style="width: 80%;">
        </colgroup>
        <tbody>
          <tr>
            <th>안 건</th>
            <td>
              {{ meeting.title }}
            </td>
          </tr>
          <tr>
            <th>일 시</th>
            <td>{{ meeting.meet_date_time|date:"Y.m.d H:i" }}</td>
          </tr>
          <tr>
            <th>장 소</th>
            <td>{{ meeting.place }}</td>
          </tr>
          <tr>
            <th>참석인원</th>
            <td>{{ meeting.attendees.count }}</td>
          </tr>
          <tr>
            <th>주요안건</th>
            <td>
              <div class="minutes-editbox" contenteditable="true">
                {# 필요하다면 서버에서 기본값을 넣을 수도 있음 #}
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    {# contents: 회의 내용 #}
    <div id="minutes-template-contents">
      <table class="minutes-table">
        <colgroup>
          <col style="width: 20%;">
          <col style="width: 80%;">
        </colgroup>
        <tbody>
          <tr>
            <th>회의 내용</th>
            <td>
              <div class="minutes-editbox" contenteditable="true"></div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    {# results: 회의 결과 #}
    <div id="minutes-template-results">
      <table class="minutes-table">
        <colgroup>
          <col style="width: 20%;">
          <col style="width: 80%;">
        </colgroup>
        <tbody>
          <tr>
            <th>회의 결과</th>
            <td>
              <div class="minutes-editbox" contenteditable="true"></div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    {# todos: 해야 할 일 #}
    <div id="minutes-template-todos">
      <table class="minutes-table">
        <colgroup>
          <col style="width: 20%;">
          <col style="width: 80%;">
        </colgroup>
        <tbody>
          <tr>
            <th>해야 할 일</th>
            <td>
              <div class="minutes-editbox" contenteditable="true"></div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    {# 참석자 표 (PDF 양식의 하단 표와 맞추기 위한 용도, 웹에서는 읽기 전용으로만 표시해도 됨) #}
    <div id="minutes-template-attendees">
      <table class="minutes-table">
        <thead>
          <tr>
            <th colspan="3">참 석 자</th>
          </tr>
          <tr>
            <th style="width: 33%;">소 속</th>
            <th style="width: 33%;">성 명</th>
            <th style="width: 34%;">서 명</th>
          </tr>
        </thead>
        <tbody>
            {% for att in meeting.attendees.all %}
              <tr>
                <td>
                  {% if att.user.dept %}
                    {{ att.user.dept.dept_name }}
                  {% endif %}
                </td>
                <td>{{ att.user.name }}</td>
                <td>(인)</td>
              </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>  {# minutes-templates 끝 #}

  {# ====== 회의록 구성 선택 팝업 ====== #}
  <div class="minutes-config-overlay" id="minutes-config-overlay" style="display:none;">
    <div class="minutes-config-modal">
      <div class="minutes-config-header">
        <h3>회의록 구성 선택</h3>
        <button type="button" class="minutes-config-close" id="minutes-config-close">
          ✕
        </button>
      </div>

      <div class="minutes-config-body">
        <form id="minutes-config-form">
          <label class="minutes-config-item">
            <input
              type="checkbox"
              name="minutes_section"
              value="base"
              checked
            />
            기본 정보 / 주요안건
          </label>

          <label class="minutes-config-item">
            <input
              type="checkbox"
              name="minutes_section"
              value="contents"
              checked
            />
            회의 내용
          </label>

          <label class="minutes-config-item">
            <input
              type="checkbox"
              name="minutes_section"
              value="results"
              checked
            />
            회의 결과
          </label>

          <label class="minutes-config-item">
            <input
              type="checkbox"
              name="minutes_section"
              value="todos"
              checked
            />
            해야 할 일
          </label>

          <label class="minutes-config-item">
            <input
              type="checkbox"
              name="minutes_section"
              value="attendees"
              checked
            />
            참석자 명단
          </label>
        </form>
      </div>

      <div class="minutes-config-footer">
        <button type="button" class="minutes-config-btn" id="minutes-config-confirm">
          확인
        </button>
        <button type="button" class="minutes-config-btn" id="minutes-config-cancel">
          취소
        </button>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_script %}
<script src="{% static 'js/meeting_detail.js' %}"></script>
{% endblock %}
